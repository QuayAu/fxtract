---
title: "Studentlife"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{fxtract}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
---

Here we show how to extract the some interesting features from phone logging data by using the R6 Class `Xtractor`.
See the [official site](http://studentlife.cs.dartmouth.edu/dataset.html) for more information on this dataset.

```{r, echo = FALSE}
unlink("fxtract_files", recursive = TRUE)
Sys.setenv(LANG = "en")
```

## Initialize Object 
```{r, message = FALSE}
library(fxtract)
xtractor = Xtractor$new("xtractor")
```

## Load Data into Object
```{r, message = FALSE, warning = FALSE}
xtractor$add_data(studentlife_small, group_by = "userId")
```

## Preprocess Data
Add weekday and date information to dataset:
```{r, message = FALSE}
xtractor$preprocess_data(fun = function(x) add_weekday(x, utc_col = "timestamp"))
xtractor$preprocess_data(fun = function(x) add_date(x, utc_col = "timestamp"))
```

## Define Feature Functions
```{r}
number_diff_apps = function(data) {
  c(number_diff_apps = length(unique(data$RUNNING_TASKS_topActivity_mPackage)))
}

number_diff_apps_weekday = function(data) {
  data_weekday = data %>% filter(weekday >= "Mon" & weekday <= "Fri")
  c(number_diff_apps_weekday = length(unique(data_weekday$RUNNING_TASKS_topActivity_mPackage)))
}

daily_number_diff_apps = function(data) {
  x = fxtract::calc_feature(data, group_by = "date", fun = number_diff_apps)
  c(daily_number_diff_apps = mean(x$number_diff_apps))
}

total_dist = function(data) {
  library(geosphere)
  long = data$longitude
  lat = data$latitude
  c(total_dist = sum(distHaversine(cbind(long, lat)), na.rm = TRUE))
}
```

## Add Feature Functions to R6 Object
```{r, message = FALSE}
xtractor$add_feature(number_diff_apps)
xtractor$add_feature(number_diff_apps_weekday)
xtractor$add_feature(daily_number_diff_apps)
xtractor$add_feature(total_dist)
```

## Get an Overview
```{r}
print(xtractor)
```

## Calculate Features 
Let's calculate the features in parallel (here on a windows machine):
```{r}
xtractor$reg$cluster.functions = batchtools::makeClusterFunctionsSocket(4)
```

```{r}
xtractor$calc_features()
```

```{r, echo = FALSE}
Sys.sleep(3)
```

## Bug Fixing
```{r}
batchtools::getStatus(reg = xtractor$reg)
```

Some jobs failed. Let's debug this now.

We can get the error messages:
```{r}
xtractor$error_messages
```

Because we calculated the functions in parallel, we need to make sure the workers have access to functions and packages.
In most of our feature functions we used `library()` inside the functions or directly used the `::` operator. 

Our function `number_diff_apps_weekday` uses `dplyr` functions without calling `library(dplyr)` within the function. 
We could update this feature function (see [here](https://quayau.github.io/fxtract/docs/articles/tutorial/basics_project_update_feature.html)),
but we'd like to show a different way. 

You can set packages, which should be available by the workers by:
```{r}
xtractor$reg$packages = c("dplyr")
```

Now we calculate the remaining features:

```{r}
xtractor$calc_features()
```

```{r, echo = FALSE}
Sys.sleep(3)
```

```{r}
xtractor$results
```

```{r, echo = FALSE}
unlink("fxtract_files", recursive = TRUE)
```
